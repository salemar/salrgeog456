<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            background-color: black;
        }
        #text { width: 300px; position:fixed; right: 70px}
        h1 {
            font-family: 'Courier New', Courier, monospace;
            color:rgb(0, 245, 164);
            right: 70px;
        }
        h2 {
            top: 25%;
            font-family: 'Courier New', Courier, monospace;
            color:rgb(161, 240, 214);
            right: 70px;
        }
        h3 {
                    color:rgb(199, 253, 235);
                    font-family: monospace;
                    position:relative;
                    top:20px;
                    text-align: right
                            }
        a {
            cursor: cell;
            position: relative;
            text-align: center;
            top: 25%;
            font-family: 'Courier New', Courier, monospace;
            color:rgb(161, 240, 214);
        }
    /* map div */
        #map{width: 850px; height: 600px; float: left;}
    /* play button */
        .play-control {
            padding: 5px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .play-control button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
        }
    /* legend */
        .legend {
                line-height: 18px;
                color: #000;
                background-color: #ffffff;
            }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7; 
        }
    </style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="">
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script src="hwy2004.js"></script>
    <script src="hwy2005.js"></script>
    <script src="hwy2006.js"></script>
    <script src="hwy2007.js"></script>
    <script src="hwy2008.js"></script>
    <script src="hwy2009.js"></script>
    <script src="hwy2010.js"></script>
    <script src="hwy2011.js"></script>
    <script src="hwy2012.js"></script>
    <script src="hwy2013.js"></script>
    <script src="hwy2014.js"></script>
    <script src="hwy2015.js"></script>
    <script src="hwy2016.js"></script>
    <script src="hwy2017.js"></script>
    <script src="hwy2018.js"></script>
    <script src="hwy2019.js"></script>
    <script src="hwy2020.js"></script>
    <script src="hwy2021.js"></script>
    <script src="stations.js"></script>
</head>

<body>
<!-- header -->
    <h3><a href='../index.html'>Home</a></h3>
    <div id="text">
        <h1>Final Project:</h1>
        <h2>Amtrak Stations and Highway Investment</h2>
        <h2 id="theYear">Year:</h2>
        <input type="range" name="year" value="38" min="0" max="56" step="1" oninput="moveSlider(this.value)">
    </div>

<!-- map -->
    <div id="map"></div>

<script>
    // play button
        window.onload = function() {
            addPlayButton();};
        
    //map
        var map = L.map('map').setView([40, -98], 3.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
            }).addTo(map); 

    // highways
        var selectedYear = '2004'
            function myStyle(feature) {
                return {
                "fillColor": getColor(feature.properties['hwySpend']),
                "weight": 0.00,
                "fillOpacity": 1}};

        var data = [ofour,ofive,osix,oseven,oeight,onine,ten,eleven,twelve,thirteen,fourteen,fifteen,sixteen,seventeen,eighteen,nineteen,twenty,twentyone] // array ordering the data. You need to be very careful with this method as you are bringing in all the data at once. 
        var order = ['2004','2005','2006','2007','2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018','2019','2020','2021'] // an array with the date of each data source

        function getColor(amt) {
            return amt < 413 ? "00000"
            :amt < 558 ? "#676789"
            :amt < 703 ? "#60608A"
            :amt < 848 ? "#52525C" 
            :amt < 992 ? "#353538" 
            : "00000";}

        var highways = L.geoJSON(data, {style: myStyle});

    // stations categories
        function getStationStatus(feature, currentYear) {
            const openedYear = feature.properties.Opened;
            const closedYear = feature.properties.Closed;
            
        const yearNum = parseInt(currentYear);
            
        if (openedYear && parseInt(openedYear) > yearNum) {
            return "UNOPENED";}
            
        const isOpened = openedYear && parseInt(openedYear) <= yearNum;
            
        const isNotClosed = !closedYear || closedYear === "" || parseInt(closedYear) >= yearNum;
            
        if (isOpened && isNotClosed) {
            return "OPEN";
            } else {
            return "CLOSED";}}

    //stations styling
        var icon = L.geoJSON(stations, {
            pointToLayer: function (feature, latlng) {
                const status = getStationStatus(feature, selectedYear);
                var style = {
                    radius: 4,
                    fillColor: status === "OPEN" ? "#7bfff7" : 
                        status === "CLOSED" ? "#6e7b7a" : "#000000",
                    color: "#e3f6f5",
                    weight: status === "OPEN" ? 1.5 : 0,
                    opacity: 0.4,
                    fillOpacity: status === "UNOPENED" ? 0 : 0.8};

                return L.circleMarker(latlng, style).bindPopup(
                    `${feature.properties.Code}: ${status}<br>
                    ${status === "UNOPENED" ? 
                    `Will open in ${feature.properties.Opened}` : 
                    `Operated ${feature.properties.Opened || 'unknown'}-${feature.properties.Closed || 'present'}`}`);}});  
    
    //slider
        function moveSlider(value) {
        
        selectedYear = 1965 + parseInt(value); 
        
        document.getElementById('theYear').innerHTML = 'Year: ' + selectedYear;
        
        map.removeLayer(highways);
        map.removeLayer(icon);
        
        if (selectedYear >= 2004 && selectedYear <= 2021) {
            highways = L.geoJSON(data[selectedYear - 2004], {style: myStyle});
            map.addLayer(highways);}
        
        icon = L.geoJSON(stations, {
            pointToLayer: function (feature, latlng) {
                const status = getStationStatus(feature, selectedYear.toString());
                var style = {
                    radius: 4,
                    fillColor: status === "OPEN" ? "#7bfff7" : 
                        status === "CLOSED" ? "#6e7b7a" : "#000000",
                    color: "#e3f6f5",
                    weight: status === "OPEN" ? 1.5 : 0.5,
                    opacity: 0.4,
                    fillOpacity: status === "UNOPENED" ? 0 : 0.8};
                return L.circleMarker(latlng, style).bindPopup(
                    `${feature.properties.Code}: ${status}<br>
                    ${status === "UNOPENED" ? 
                    `Will open in ${feature.properties.Opened}` : 
                    `Operated ${feature.properties.Opened || 'unknown'}-${feature.properties.Closed || 'present'}`}`);}});
        
        map.addLayer(icon);}

        moveSlider('0')

    //play button
        var animationInterval;
        var isPlaying = false;

        function addPlayButton() {
        var playControl = L.control({position: 'topright'});
        
        playControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'play-control');
            div.innerHTML = '<button id="playButton">▶ Play</button>';
            return div;};
        
        playControl.addTo(map);
        
        document.getElementById('playButton').addEventListener('click', function() {
            if (isPlaying) {
            pauseAnimation();
            } else {
            playAnimation();}});}

        function playAnimation() {
        var playButton = document.getElementById('playButton');
        playButton.textContent = '⏸ Pause';
        isPlaying = true;
        
        var currentValue = parseInt(document.querySelector('input[name="year"]').value);
        var maxValue = parseInt(document.querySelector('input[name="year"]').max);
        
        animationInterval = setInterval(function() {
            currentValue++;
            
            if (currentValue > maxValue) {
            currentValue = 0;
            }
            
            document.querySelector('input[name="year"]').value = currentValue;
            moveSlider(currentValue);
            
        }, 700);
        }

        function pauseAnimation() {
        var playButton = document.getElementById('playButton');
        playButton.textContent = '▶ Play';
        isPlaying = false;
        clearInterval(animationInterval);
        }
    
    // legend
        var legend = L.control({position:'bottomleft'});
            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend'),
                grades =[415, 558, 703, 848, 992],
                labels = [];
            for (var i= 0; i < grades.length; i++) {
                div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                        grades[i] + (grades[i + 1] ? '&ndash;' : ',000,000');
                }
                return div;        
            };
        legend.addTo(map);

    //layer control
    function addLayerControl() {
    // Create separate layer groups for highways and stations
    var highwaysLayer = L.layerGroup();
    var stationsLayer = L.layerGroup();
    
    // Add initial layers to their respective groups
    highways.addTo(highwaysLayer);
    icon.addTo(stationsLayer);
    
    // Define base layers (just the basemap in this case)
    var baseLayers = {
        "CartoDB Dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        })
    };
    
    // Define overlay layers
    var overlays = {
        "Highway Investments": highwaysLayer,
        "Amtrak Stations": stationsLayer
    };
    
    // Add layer control to map
    L.control.layers(baseLayers, overlays, {
        collapsed: true,  // Control starts collapsed
        position: 'topright'  // Position on map
    }).addTo(map);
    
    // Update the layers when slider moves
    function updateLayers(year) {
        highwaysLayer.clearLayers();
        stationsLayer.clearLayers();
        
        // Add highways if year >= 2004
        if (year >= 2004) {
            var yearIndex = year - 2004;
            if (data[yearIndex]) {
                L.geoJSON(data[yearIndex], {style: myStyle}).addTo(highwaysLayer);
            }
        }
        
        // Always add stations
        L.geoJSON(stations, {
            pointToLayer: function (feature, latlng) {
                const status = getStationStatus(feature, year.toString());
                var style = {
                    radius: 4,
                    fillColor: status === "OPEN" ? "#00FF00" : 
                              status === "CLOSED" ? "#FF0000" : "#FFFF00",
                    color: "#FFF",
                    weight: 1,
                    opacity: status === "UNOPENED" ? 0.3 : 1,
                    fillOpacity: status === "UNOPENED" ? 0 : 0.8
                };
                return L.circleMarker(latlng, style).bindPopup(
                    `${feature.properties.Code}: ${status}<br>
                    ${status === "UNOPENED" ? 
                     `Will open in ${feature.properties.Opened}` : 
                     `Operated ${feature.properties.Opened || 'unknown'}-${feature.properties.Closed || 'present'}`}`
                );
            }
        }).addTo(stationsLayer);
    }
    
    // Modify your existing moveSlider function to use updateLayers
    window.moveSlider = function(value) {
        var year = 1965 + parseInt(value);
        document.getElementById('theYear').innerHTML = 'Year: ' + year;
        updateLayers(year);
    };
}

// Call this function after your map is initialized
addLayerControl();
    </script>

</body>
</html>